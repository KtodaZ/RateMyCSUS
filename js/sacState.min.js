function main(){$(document).ready(function(){initScript(),checkIframe()})}function initScript(){console.clear(),log(extensionName+" Running"),chrome.runtime.sendMessage({greeting:"show_page_action"})}function checkIframe(){function f(){for(var a=0;a<timers.length;a++)clearTimeout(timers[a])}function g(){$(".qtip").remove()}function h(){a=$(iframeObject).contents().find("body"),b=$(a).html()}function i(){var a=document.createElement("div");return a.innerHTML=b,a}function j(b){try{$(a).html(b)}catch(a){}}function k(){timers.push(setInterval(function(){debugging>0&&log("Scanning for changes"),h(),l()&&(debugging>0&&(log("Page changed. Restarting search."),console.clear()),checkIframe())},timerWaitVal))}function l(){return 0==$(".link",a).length}var a,b;debugging>0&&log("Scanning page for professors"),f(),g(),h();var c=i(),d=performance.now(),e=detectAndAggregateProfessors(c);e?(j(e),k(),log("Professors found, script executed. Script load took "+(performance.now()-d)+" milliseconds.")):timers.push(setTimeout(function(){checkIframe()},timerWaitVal))}function detectAndAggregateProfessors(a){function r(a){var e="";if(0===a.trim().localeCompare("Staff"))e+="Staff";else{if(!c.test(a)||isStringArrayInString(exclusions,a))return!1;debugging>1&&log("Regex passed for: "+a);var f=a.indexOf("Staff");f!==-1?(e+="<br>"+a.substring(f),d.push(a.substring(0,f))):d.push(a),e+='<a class="link" id="'+profIDPrefix+b+'" href="'+getAllSchoolsURL(d[d.length-1])+'" target="_blank" title="RMP Search page">'+a+"</a>",b++}return e}function u(){return $('[id*="'+profIDContains+'"][class="'+profClass+'"]',a)}function v(a){$(a).qtip({content:{text:'<div id="contentBox" style=" padding-right: 10px; width:95%"> <b>Click</b> the links to view their Rate My Professor page </div>',title:'<div id="contentBox" style=" padding-right: 10px; width:90%"> <b>Hover</b> over any professor name to view their ratings </div>',button:"close"},position:{target:[700,115],viewport:iframeObject},style:{classes:"qtip-bootstrap",width:190,tip:{corner:!1}},show:{solo:!0,ready:!0},hide:{event:"unfocus",leave:!1,fixed:!0,effect:function(a){$(this).fadeOut(200)}}})}function w(a,b){var c=!1;$(a).mouseenter(function(){c||($(a).qtip("option","content.title",'<div id="contentBox" style=" padding-right: 10px; width:95%"> <b>'+b+"</b></div>"),$(a).qtip("option","content.text","Loading . . ."),x(a,b),c=!0)})}function x(a,b){debugging>1&&log(b),chrome.runtime.sendMessage({debug:debugging,step:0,url:getSacStateProfURL(b)},function(c){var d=c;debugging>0&&log("URL retrieved: "+d),null!=d?chrome.runtime.sendMessage({debug:debugging,step:1,url:d},function(c){function o(a,b){return'<a class="link" href="'+a+'" target="_blank" title='+b+">"+b+"</a>"}var e=c,f=e[0],g=e[1],h=e[2],i=e[3],j=e[4],k=chrome.extension.getURL("images/down.png"),l=chrome.extension.getURL("images/up.png"),m=[];if(m.push('<div id="contentBox" style="margin:0px auto; height:100%; width:100%">'),"No Ratings"==e||"N/A"==f&&"N/A"==g&&"N/A"==h&&0==j.tags.length)m.push("This professor has no ratings for Sacramento State. <br>"),m.push(o(getAllSchoolsURL(b),"Search other schools")),a.title="Search other schools for "+b;else{if(m.push('<div id="column1" style="float:left; margin:0; width:80%;">'),m.push("Overall Quality:<br>Would take again:<br>Level of difficulty:<br>"),i&&m.push("Hotness:<br>"),j.tags.length>0&&(m.push('<a role="button" data-toggle="collapse" data-parent="#accordion" style="outline:none;" href="#'+a[0].id+'tagsBox" aria-expanded="false" aria-controls="'+a[0].id+'tagsBox">'),m.push("Tags</a>")),m.push("</div>"),m.push('<div id="column2" style="float:left; margin:0;width:20%;">'),m.push(f+"<br>"+g+"<br>"+h),i&&m.push("<br>"+i),m.push('<br style="line-height: 21px;">'),j.tags.length>0&&m.push('<input type="image" alt="Submit Form" id="'+a[0].id+'icon" style="outline:none;"  width="20" height="13" data-toggle="collapse" data-target="#'+a[0].id+'tagsBox" src="'+k+'" />'),m.push("</div>"),j.tags.length>0){m.push('<div class="panel-group" id="'+a[0].id+'accordion" role="tablist" aria-multiselectable="false" style="float:left; display: none; padding-top: 5px; margin:0;width:100%;">'),m.push('<div class="panel panel-default">'),m.push('<div class="panel-collapse collapse" id="'+a[0].id+'tagsBox" role="tabpanel" aria-labelledby="'+a[0].id+'tagsBox" >'),m.push('<div class="panel-body" style="line-height: 10px; padding-top: 2px; padding-bottom: 5px; padding-left: 8px; padding-right: 5px;">');for(var n=0;n<j.tags.length;n++)m.push('<span style="font-size: x-small; ">'),m.push(j.tags[n]),m.push("</span>"),m.push('<br style="line-height:0px;" />');m.push("</div>"),m.push("</div>"),m.push("</div>"),m.push("</div>")}a.title=b+" on RateMyProfessor"}m.push("</div>"),$(a).qtip("option","content.text",m.join("")),$(a).attr("href",d),$("#"+a[0].id+"tagsBox").on("hide.bs.collapse",function(){$("#"+a[0].id+"icon").attr("src",k),$("#"+a[0].id+"accordion").hide()}),$("#"+a[0].id+"tagsBox").on("show.bs.collapse",function(){$("#"+a[0].id+"icon").attr("src",l),$("#"+a[0].id+"accordion").show()})}):(d=getAllSchoolsURL(b),$(a).qtip("option","content.text",'<div id="contentBox" style="margin:0px auto; height:100%; width:100%">No professors found. <a class="link" id ="search_schools_link" href="'+d+'" target="_blank" title="Search other schools">Search other schools</a></div>'),$(a).attr("href",d),a.title="Search other schools")})}for(var b=0,c=/^([ ]?\n?([A-Z][a-z]*(\'|\-)?[A-Z]?[a-z]+[ ]?){2,3})?(\nStaff)?$/,d=[],e=u(),f=0;f<e.length;f++){for(var g=$(e[f]).text().trim().split(/[,]+/),h='<div id="contentBox" style="margin:0px auto; width:100%">',i=0;i<g.length;i++){var j=!1,k=g[i].trim(),l=k.split(/[\n]+/);if(debugging>1&&log(l),2===l.length||3===l.length){var m=l[0].trim(),n=l[1].trim();3===l.length&&(n+=l[2].trim());var o=r(m),p=r(n);if(!o||!p)continue;h+=o+"<br>"+p,j=!0}else{var q=r(k);if(!q)continue;h+=q,j=!0}i!=g.length-1&&(h+=",<br>")}h+="</div>",j&&($(e[f]).text(""),e[f].innerHTML=h)}if(b>0){for(var s=0;s<d.length;s++){var t=$("#"+profIDPrefix+s,a);v(t),w(t,d[s],d[s])}return a}return!1}function getSacStateProfURL(a){return"http://www.ratemyprofessors.com/search.jsp?queryBy=teacherName&schoolName="+rmpSchoolUrl+"&queryoption=HEADER&query="+encodeURI(a)+"&facetSearch=true"}function getAllSchoolsURL(a){return"http://www.ratemyprofessors.com/search.jsp?queryBy=teacherName&query="+encodeURI(a)}function isStringArrayInString(a,b){for(var c=0;c<a.length;c++)if(b.indexOf(a[c])!==-1)return!0;return!1}function log(a){console.log(a)}var extensionName="RateMyCSUS",rmpSchoolUrl="California+State+University%2C+Sacramento",exclusions=["TBA","Online","Fee","Web","Arranged","StaffStaff"],iframeObject=$("#ptifrmtgtframe"),timers=[],debugging=0,profIDPrefix="profID",timerWaitVal=2500,profIDContains="INSTR",profClass="PSLONGEDITBOX";main();